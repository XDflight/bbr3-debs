# 最新の Linux カーネル、Google BBR v3 を統合

**言語を選択:** &nbsp; [English](README.md) &nbsp; [中文](README_zh.md) &nbsp; [日本語](#)

> **簡単なまとめ:** BBR は高速・長距離リンクで大幅なスループット向上を実現します。BBR のスループットは、現在最も優れた損失ベースの輻輳制御である CUBIC より 2700 倍も高くなります（CUBIC は約 3.3 Mbps、BBR は 9100 Mbps を超えます）。また、BBR はインターネットに接続するラストマイルネットワークでの遅延を大幅に削減します。BBR はキューイング遅延を CUBIC の 1/25 に抑えることができます [(BBR v1 公式ブログ 2017)](https://cloud.google.com/blog/products/networking/tcp-bbr-congestion-control-comes-to-gcp-your-internet-just-got-faster)。BBR v3 は BBR v1 の改良版で、まだカーネルに統合されていません。

### ワンクリックでインストール & 更新 & 修復
**重要な注意事項:**
- 以下のコマンドを実行する前に、管理者権限を持つユーザー（つまり `sudo` が使用可能なユーザー）としてシステムにログインしていることを確認してください。
- このリポジトリで提供されるパッケージをインストールするには、システムに `dpkg` がインストールされている必要があります。`dpkg` は Debian/Ubuntu システムに付属しています。
- システムが GRUB 以外のブートローダーを使用している場合、スクリプトの実行後に手動でブートローダーを更新して新しいカーネルを起動する必要があります。
- 可能であれば、操作を行う前にデータをバックアップしてください。スクリプトは堅牢に設計されており、問題が発生してもシステムやデータを破損しないようになっていますが、このリポジトリの開発者はスクリプトの使用に関して一切の責任を負いません。

Google BBR v3 を統合して有効化した最新の Linux カーネルをインストールするには、以下のコマンドを実行してください:
```
curl -sL "https://raw.githubusercontent.com/XDflight/bbr3-debs/refs/heads/build/install_latest.sh" | sudo bash -s
```
中国本土のユーザーは、以下のコマンドを実行してダウンロード速度を向上させることができます:
```
curl -sL "https://ghfast.top/https://raw.githubusercontent.com/XDflight/bbr3-debs/refs/heads/build/install_latest.sh" | sudo CDN_URL="https://ghfast.top/" bash -s
```
すべてのステップがエラーなく完了した場合、準備完了です！
必須の再起動を除いて、追加の設定は必要ありません。

再起動後にすべてが正常に動作していることを確認するには、再度同じコマンドを実行してください。
スクリプトの出力に `sysctl settings are correct.` と表示されることを期待できます。
チェックが失敗した場合、スクリプトは自動的にカーネルや sysctl 設定を修復します。

このコマンドはカーネルの更新にも使用できます。
実行するたびにカーネルの更新をチェックし、新しいバージョンが利用可能な場合はカーネルを更新します。

**現在サポートされている CPU アーキテクチャ:**
- `amd64` / `x86-64`
- `i386` / `i686` / `ia32` / `x86` / `x86-32`
- `arm64` / `aarch64`
- `armhf` / `armv7` / `arm` / `arm32` / `aarch32` (ハードフロート)
- `riscv64`

**非対話型フローでスクリプトを使用する:**
スクリプトがユーザーに再起動を促すのを防ぐには、スクリプトの最初の引数として `-y`（`--yes`）または `-n`（`--no`）を指定して、インストール、更新、修復後にシステムを自動的に再起動するかどうかを選択できます。

---

### BBR v3 とは？なぜこのリポジトリが存在するのか？
BBR に関する研究論文は [こちら (2016)](https://research.google/pubs/bbr-congestion-based-congestion-control-2/) と [こちら (2017)](https://dl.acm.org/doi/10.1145/3009824) で見つけることができます。
簡単な説明としては、Google BBR の開発チームが執筆した [この記事 (2017)](https://cloud.google.com/blog/products/networking/tcp-bbr-congestion-control-comes-to-gcp-your-internet-just-got-faster) が良い導入となります。
基本的に、BBR は帯域幅と RTT（往復時間）の両方を考慮してデータ転送を最適化することでネットワーク性能を向上させることを目的としています。
BBR v1 はすでに Linux カーネル `4.9` にマージされています。
BBR v3 は BBR v1 の改良版であり、主に不公平や高い再送信率に関連する問題に対処することを目的としています。
しかし、BBR v3 はまだカーネルにマージされていません。
`google/bbr` で使用されている現在の Linux カーネルは `6.13.7` です。
このリポジトリは、BBR 開発チームによって行われたすべてのコミットをカーネルソースツリーにリベースすることを目的としており、人々が新しい Linux カーネル（特に最新の安定版および LTS バージョン）で BBR v3 を使用できるようにしています。
便利なことに、GitHub ワークフローが設定されており、これらの「修正された」カーネルを `.deb` パッケージにコンパイルして GitHub でリリースしています。これにより、Debian/Ubuntu ユーザーは簡単にカーネルをインストールできるようになります。

### コンパイルのハイライト
- 4 つの TCP 輻輳制御アルゴリズムが利用可能です: `bbr` (Google BBR3)、`dctcp`、`cubic`、および `reno`。 `bbr` はデフォルトでビルトインされており、`dctcp` と `cubic` はモジュールとしてコンパイルされ、`reno` は Linux カーネルに最初から付属している「オリジナル」のものなのでビルトインされています。一般的に、`bbr` は一般的な目的（特に高帯域幅および可変/高遅延環境）に推奨されており、`dctcp` はデータセンターなどの低遅延環境に推奨されています。 `cubic` と `reno` は主にデバッグやテスト目的のために含まれています（それらに関する詳細情報はオンラインで見つけることができます）。 `bbr` がデフォルトアルゴリズムであるため、`sysctl.d` で `net.ipv4.tcp_congestion_control = bbr` を設定する必要はありません。
- 2 つの TCP アクティブキュー管理アルゴリズムが利用可能です: `fifo` と `fq_codel`。 それらに不慣れな場合は、デフォルトのもの（`fq_codel`）を使用すればほとんどのシナリオで問題ありません。 `fifo` はその名の通り、元々カーネルに付属している非常にシンプルな AQM アルゴリズムであり、`fq_codel` は BBR ともうまく機能し、慎重なパラメータ調整を必要とせず、すべてのネットワーク環境で非常に堅牢であるため、デフォルトとして設定されています。
- その他の設定は基本的に「現在最新の」（あなたがこの `README` を読んでいるときにはそうではない可能性が高いですが）公式 Debian カーネル `6.1.0-35-amd64` （Linux カーネル `6.1.137` に基づいています）から継承されており、新しいカーネルに設定を適応させるためにマイナーな変更が加えられています。強調すべき点は次の 2 つです:
    1. カーネルデバッグ情報は、GitHub へのアップロードおよびダウンロードに非常に大きいため、省略されています。また、カーネル開発を行わない限り、一般的には役に立ちません。心配しないでください。多くのディストリビューションでも、標準インストール時にカーネルデバッグ情報を省略し、スタンドアロンパッケージとして提供しています。
    1. Transparent Hugepage Support (THP) は、デフォルトでカーネルに統合されていません。これは、多くのデータベースシステムによって推奨されているためです（おそらく多くの人がサーバーにこれらのカーネルをインストールするでしょう）。とにかく、この設定は `/sys/kernel/mm/transparent_hugepage/` で自分で変更できます。

### ダウンロード
[GitHub Releases](https://github.com/XDflight/bbr3-debs/releases) ページでは、コンパイルされたカーネルが `.deb` ファイルにパッケージ化されているのを見つけることができます。
使用したいバージョンを選択してください。
各リリースには、どのバージョンを選択すべきかを判断するのに役立つカーネルバージョンの簡単な説明が付属しています。

一般的には、次のいずれかのバージョンを探してください:
- **互換性と手間の少なさを重視する場合:** 現在のカーネルと同じ（または近い）メジャーバージョン（最初の 2 つの数字）を持つ最新のカーネルを選択してください。カーネルのバージョンは `uname -a` を使用して確認できます。
- **安定性とセキュリティを重視する場合:** 最新の LTS カーネルを選択してください。
- **機能と新しいハードウェアのサポートを重視する場合:** 最新のカーネルを選択してください。

いずれにせよ、現在のカーネルバージョンよりも高い/新しいカーネルバージョンを選択してください。そうしないと、多くのブートローダー（GRUB など）がデフォルトで最新のカーネルを起動してしまいます。

アーキテクチャ（`amd64`、`arm64` など）については、システムで使用されているものを選択してください。

リリースに含まれる 3 つのパッケージすべてをダウンロードしてください。すなわち、次のものです:
- `linux-headers-*`: カーネルのヘッダーファイル。外部カーネルモジュールをビルドするのに役立ちます。
- `linux-image-*`: カーネルバイナリ - 最も重要なものです。
- `linux-libc-dev-*`: 標準 C ライブラリ `libc` およびその他のユーザースペースの重要なコンポーネント。

### インストール
1. Linux ターミナルで `sudo dpkg -i linux-*.deb` を実行します。ダウンロードしたファイルがあるディレクトリにいることを確認してください。
1. `sudo update-grub` を実行して GRUB ブートローダーを更新します。このステップは、Raspberry Pi や uBoot を使用している場合など、他のブートローダーを使用している場合は異なる場合があります。新しいカーネルを起動するためにブートローダーを適切に更新する方法については、オンラインの指示を確認してください。
1. 現在の `/etc/sysctl.conf` および `/etc/sysctl.d/*.conf` 設定ファイルに、デフォルト値を上書きしてしまう可能性のある `net.ipv4.tcp_congestion_control` または `net.core.default_qdisc` が含まれていないか確認してください。次のコマンドを使用して、これらを迅速に削除できます:
    - `sudo sed -i '/net.ipv4.tcp_congestion_control/d' /etc/sysctl.conf`
    - `sudo sed -i '/net.ipv4.tcp_congestion_control/d' /etc/sysctl.d/*.conf`
    - `sudo sed -i '/net.core.default_qdisc/d' /etc/sysctl.conf`
    - `sudo sed -i '/net.core.default_qdisc/d' /etc/sysctl.d/*.conf`
1. RTT をさらに短縮するために TCP Fast Open (TFO) を有効にすることをお勧めします。TFO は Google のチームによって提案され、RFC 7413 に記載されています。これを行うには、次の手順に従ってください:
    1. `sysctl net.ipv4.tcp_fastopen` を実行します。現在の値が `3` の場合、変更する必要はありません。
    1. それ以外の場合は、`net.ipv4.tcp_fastopen = 3` をいずれかの `sysctl.d` ファイルに追加します。方法については、オンラインの指示を確認してください。
1. TCP ECN を有効にしてパケットロスをさらに減少させることをお勧めします。ECN は、ルーターがパケットを破棄することなく、エンドポイントにネットワーク輻輳の差し迫った状態を通知できるようにします。これを行うには、次の手順に従ってください:
    1. `sysctl net.ipv4.tcp_ecn` を実行します。現在の値が `1` の場合、変更する必要はありません。
    1. それ以外の場合は、`net.ipv4.tcp_ecn = 1` をいずれかの `sysctl.d` ファイルに追加します。方法については、オンラインの指示を確認してください。
1. システムを再起動します。新しいカーネルが正常に動作していることを確認するには、次のチェックを行ってください:
    - `uname -r` を実行すると、新しいカーネルバージョンと `-bbr3` バージョンサフィックスが表示されるはずです。
    - `sysctl net.ipv4.tcp_congestion_control` を実行すると、`bbr` が表示されるはずです。
    - `sysctl net.core.default_qdisc` を実行すると、`fq_codel` が表示されるはずです。
    - `sysctl net.ipv4.tcp_fastopen` を実行すると、設定されている場合は `3` が表示されるはずです。
    - `sysctl net.ipv4.tcp_ecn` を実行すると、設定されている場合は `1` が表示されるはずです。
1. やった！ システムは現在 BBR v3 で完全に構成されています。
1. 上記と同じ手順でカーネルを更新できます。

---

### リリーススケジュール
コンパイルされたカーネルは、毎週定期的に、または新しいカーネルバージョンが利用可能になったときにリリースされます。
具体的には、毎週月曜日の 07:21 UTC に GitHub ワークフローが自動的にトリガーされ、最新の安定したカーネルのソースコードをプルし、BBR v3 を統合してコンパイルします。
その後、コンパイルされた `.deb` パッケージが GitHub Releases ページにドラフトリリースとしてアップロードされます。
ドラフトリリースは、タグが割り当てられ、リリースノートが作成された後に手動で公開されます。
コンパイル中に異常が発生した場合、特にパッチファイルがアップストリームの競合によりクリーンに適用できない場合、ワークフローは失敗し、後でパッチファイルがレビューされて修正されます。
これには時間がかかる場合がありますので、しばらくお待ちください。
BBR 開発チームからの更新情報、特に `google/bbr` リポジトリ、BBR Development Google Group、および `ietf-wg-ccwg/draft-ietf-ccwg-bbr` の RFC 草案からの更新情報も注意深く監視され、最新の BBR の開発に追いつくためにパッチファイルに変更が加えられます。

### 貢献
問題に遭遇した場合や、このプロジェクトに貢献したい場合は、問題を報告したりプルリクエストを作成したりしてください。
提案や改善は大歓迎です。
ちなみに、ここだけでなく、BBR 開発チームにもパフォーマンス関連の問題を報告して、彼らが調査し、上流のコードで問題を修正できるようにしてください。ありがとう！
